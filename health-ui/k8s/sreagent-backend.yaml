apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-reader-sa
  namespace: sreagent
  annotations:
    # 1. Replace this with the Client ID from your Azure Portal/CLI
    azure.workload.identity/client-id: "f0ae3cdf-e852-44e8-a3cf-d8acc158b7c4"
    # 1. ADD THIS: Your Azure Tenant ID
    azure.workload.identity/tenant-id: "3416e164-f15c-49dd-8b93-e675843857eb"
    # 2. ADD THIS: Ensures the token doesn't expire too quickly during debug
    azure.workload.identity/service-account-token-expiration: "86400"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sreagent-backend
  namespace: sreagent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sreagent-backend
  template:
    metadata:
      labels:
        app: sreagent-backend
        # 2. This label tells AKS to inject the Azure Identity token
        azure.workload.identity/use: "true"
    spec:
      # 3. This tells the pod to use the identity permissions
      serviceAccountName: prometheus-reader-sa
      # 3. ADD THIS: Security best practice for Workload Identity
      securityContext:
        fsGroup: 65534
      containers:
      - name: sreagent-backend
        image: kunyiliu1022/sreagent-backend:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8000
        # It is good practice to explicitly pass the Workspace ID as an env var
        env:
        - name: PROMETHEUS_WORKSPACE_ID
          value: "defaultazuremonitorworkspace-wus2"
        # 2. Pull all the "Sensitive" variables from your Secret
        envFrom:
        - secretRef:
            name: backend-secrets
---
apiVersion: v1
kind: Service
metadata:
  name: sreagent-backend
  namespace: sreagent
spec:
  selector:
    app: sreagent-backend
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000
  type: ClusterIP